name: Terraform Apply

on:
  push:
    branches:
      - main
    paths:
      - 'env/**'
      - 'modules/**'
  pull_request:
    paths:
      - 'env/**'
      - 'modules/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Specific environment to apply (e.g., env/product-a/dev)'
        required: false
        type: string

env:
  TF_VERSION: '1.5.7'
  TF_VAR_datadog_api_key: ${{ secrets.DATADOG_API_KEY }}
  TF_VAR_datadog_app_key: ${{ secrets.DATADOG_APP_KEY }}

jobs:
  detect-changes:
    name: Detect Changed Environments
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed environments
        id: set-matrix
        run: |
          set -euo pipefail

          # --- Manual input ---
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.environment || '' }}" ]; then
            if [ -d "${{ github.event.inputs.environment }}" ]; then
              ENVS=$(printf '%s\n' "${{ github.event.inputs.environment }}" | jq -R -s -c 'split("\n")[:-1]')
              echo "matrix=$ENVS" >> $GITHUB_OUTPUT
              echo "✅ Manual environment selected: $ENVS"
              exit 0
            else
              echo "❌ Invalid environment path: ${{ github.event.inputs.environment }}" >&2
              exit 1
            fi
          fi

          # --- Auto detect changed directories ---
          echo "🔍 Detecting changes between commits..."
          git fetch origin main --depth=2 || true

          # For push events
          if [ "${{ github.event_name }}" = "push" ]; then
            DIFF_BASE="${{ github.event.before }}"
            [ "$DIFF_BASE" = "0000000000000000000000000000000000000000" ] && DIFF_BASE="HEAD~1"
            CHANGED=$(git diff --name-only "$DIFF_BASE" ${{ github.sha }} -- 'env/' 'modules/')
          else
            # For pull_request
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} -- 'env/' 'modules/')
          fi

          if [ -z "$CHANGED" ]; then
            echo "No changes detected under env/ or modules/"
            echo "matrix=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED"

          # Extract unique env subdirectories like env/product-a/dev
          ENVS=$(echo "$CHANGED" | grep '^env/' | cut -d'/' -f1-3 | sort -u | jq -R -s -c 'split("\n")[:-1]')
          if [ "$ENVS" = "[]" ]; then
            echo "No environment directories changed. Skipping apply."
            echo "matrix=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "matrix=$ENVS" >> $GITHUB_OUTPUT
          echo "✅ Changed environments: $ENVS"

  terraform-apply:
    name: Terraform Apply
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.matrix != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    defaults:
      run:
        working-directory: ${{ matrix.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure JFrog credentials
        run: |
          mkdir -p ~/.terraform.d
          cat > ~/.terraform.d/credentials.tfrc.json <<EOF
          {
            "credentials": {
              "trialjaswin.jfrog.io": {
                "token": "${{ secrets.JFROG_ACCESS_TOKEN }}"
              }
            }
          }
          EOF

      - name: Set Terraform Workspace Name
        id: set-workspace
        run: |
          WORKSPACE_NAME=$(echo "${{ matrix.environment }}" | cut -d'/' -f2- | tr '/' '-')
          echo "WORKSPACE_NAME=$WORKSPACE_NAME" >> $GITHUB_ENV
          echo "workspace=$WORKSPACE_NAME" >> $GITHUB_OUTPUT
          echo "Using workspace: $WORKSPACE_NAME"

      - name: Select/Create Terraform Workspace
        run: |
          set -euo pipefail
          ENV_NAME=$(basename "${{ matrix.environment }}")
          echo "🧩 Using Terraform workspace: $ENV_NAME"
          terraform workspace select "$ENV_NAME" 2>/dev/null || terraform workspace new "$ENV_NAME"

      - name: Terraform Init
        env:
          TF_WORKSPACE: ${{ env.WORKSPACE_NAME }}
        run: terraform init -input=false -reconfigure

      - name: Terraform Validate
        env:
          TF_WORKSPACE: ${{ env.WORKSPACE_NAME }}
        run: terraform validate

      - name: Terraform Apply
        env:
          TF_WORKSPACE: ${{ env.WORKSPACE_NAME }}
        run: terraform apply -auto-approve -input=false
